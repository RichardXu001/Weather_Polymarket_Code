# 动态 NOAA 下跌交易策略 (V4.2.2 - 三阶段参数化版)

## 1. 策略概览
本策略通过监控核心气象源（NOAA）与辅助源（Open-Meteo, Met.no）的实时跌幅，在气温见顶回落的瞬间抢占 Polymarket 胜算。V4.2.2 引入了灵活的**三阶段动态门槛**，优化了收官阶段（16:00 后）的抢跑性能。

## 2. 三阶段触发矩阵

系统通过 `.env` 参数驱动，根据站点本地时间自动切换逻辑模式。

| 阶段名称 | 时间窗口 (默认) | 触发条件 (Resonance) | 持续计数 (Duration) | 跌幅深度 (Depth) | NOAA 必选 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **Phase 1: 严谨期** | 14:00 - 15:00 | ≥ 2 源共振 | 3 次 (3min) | 0.3°C | **YES** |
| **Phase 2: 窗口期** | 15:00 - 16:00 | ≥ 1 源触发 | 3 次 (3min) | 0.3°C | NO |
| **Phase 3: 灵敏期** | 16:00 - 17:00 | ≥ 1 源触发 | **瞬时 (Skip count)** | 0.3°C | NO |

### 核心参数定义:
- **Resonance (共振)**: 跌幅达标的可信源数量（NOAA, OM, MN）。
- **Duration (持续)**: 连续满足下跌门槛的采样次数，用于过滤高频噪声。
- **Depth (深度)**: 当前温度相对于该源今日最高温的跌幅。

## 3. 关键判定增强

### 3.1 源锚点同步 (Source Anchoring)
每个数据源均独立追踪其今日最高温（如 `max_temp_om`），决策时对比该源自身的历史峰值，以消除不同气象站之间的绝对值系统偏差。

---

## 4. 多温标兼容性 (Celsius/Fahrenheit Support) [NEW]

系统通过 `locations.json` 中的 `unit` 字段自动适配不同地区的温标（如 NYC 使用华氏度 °F）。

### 4.1 自动温标转换
- **核心逻辑**: 策略内部统一使用摄氏度 (Celsius) 进行共振计算，以确保跨源算法的一致性。
- **执行映射**: 在下单触发阶段，系统会根据目标站点的 `unit` 设置，自动将触发阈值转换为对应温标（如 $F = C \times 1.8 + 32$）。

### 4.2 智能合约匹配 (Smart Matching)
针对美国市场（如 NYC）常见的复杂合约名，系统实现了正则语义匹配：
- **范围合约**: 自动识别并匹配 `24-25°F` 类型的中继合约。
- **边界合约**: 完美识别 `24°F or below` 或 `26°F or higher`。
- **单位映射**: 确保在执行买入时，`target_asset` 能够精准指向正确的离散合约档位。

## 5. 异常源隔离逻辑 (Outlier Isolation)

为了应对个别数据源发生设备故障或极端数据噪声，系统保留了异常隔离能力：
- **触发机制**: 可通过 `.env` 中的 `STRATEGY_OUTLIER_DETECTION_ENABLED` 开关实时控制。
- **隔离门槛**: 当配置开启时，若某源读数与其它两源的平均值偏差绝对值 **> 1.5°C**，则该源在当前采样点将被视为“不可信”，不参与共振计算。
- **默认状态**: 出于稳定性考虑，当前默认设置为 `false`（即全量采信），但在极端天气波动时建议开启。

## 5. 强制执行与防御

- **17:00 强制买入 (`BUY_FORCE`)**: 若整日均未触发下跌信号，则在 17:00 准点切入。
- **全线价格保护**: 无论何种信号，若目标合约价格（Yes Ask） **≤ 0.5 USDC**，则放弃交易并标记为 `SKIP_PRICE`。
- **独立审计存证**: 每一笔信号及其决策逻辑（Res/Dur/Depth）均持久化至 `data/trades/`。

---
*最后更新：2026-02-10 | 策略标准：V4.2.2*
