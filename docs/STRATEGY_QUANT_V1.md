# 天气量化交易完整策略 (伦敦 EGLC 站点)

## 1. 核心模型：NOAA 物理还原回归
通过对历史数据进行回归分析，我们将 NOAA 的整数输出还原为**高精度的物理拟合值**：
- **拟合公式**：`V_fit = 0.52 * OM_Actual + 0.45 * MN_Actual`
- **跳变逻辑**：`NOAA_Estimated = int(floor(V_fit + 0.5))` (标准四舍五入)
- **合约匹配**：只选择 `target == NOAA_Estimated` 的合约进行交易，确保预测温度与合约阈值精准对齐

## 0. 环境配置自定项 (高度参数化)
本策略的所有量化判据均可通过 `.env` 文件进行无代码配置：
- **预测约束**: `STRATEGY_REQUIRE_FORECAST_DROP` (True: 强制要求预测值 <= 当前值)。
- **共识逻辑**: 
    - `STRATEGY_MIN_RESONANCE_SOURCES`: 参与共振的最少来源数。
    - `STRATEGY_MIN_DROPS_PER_SOURCE`: 每个源的最小下跌采样点。
    - `STRATEGY_TOTAL_REQUIRED_DROPS`: 跨源总下跌累计次数目标。
    - `STRATEGY_REQUIRE_NOAA_DROP`: NOAA 是否必须参与下跌。
- **时间窗口**: `STRATEGY_PEAK_HOUR_START` / `END` (伦敦本地时间)。

## 2. 核心买入信号：分层判定体系

### 第一层：核心前提 (必备条件)
1.  **时间限制**：当前伦敦时间必须在 `PEAK_HOUR` 窗口内。
2.  **预测方向**：若开启 `REQUIRE_FORECAST_DROP`，则 `Consensus_Forecast` (1h) 必须 $\le$ 当前 `Consensus_Actual`。

### 第二层：趋势共振确认 (可配置逻辑)
系统将同时监控三个维度：`NOAA`, `OM`, `MN`。
- **执行逻辑**：
    - 计算每个源的连续下跌次数。
    - 统计满足 `MIN_DROPS_PER_SOURCE` 的来源总数。
    - 累加所有正在下跌来源的总跌幅频次。
- **确认标准**：
    - **来源数达标**：活跃下跌源 $\ge$ `MIN_RESONANCE_SOURCES`。
    - **频次达标**：总下跌频次 $\ge$ `STRATEGY_TOTAL_REQUIRED_DROPS`。
    - **NOAA 校验**：如果 `REQUIRE_NOAA_DROP` 为真，则 NOAA 必须也在下跌序列中。

### 第三层：跳变避让信号 (非对称风险模型)
> [!IMPORTANT]
> **逻辑核心**：只有在跳变发生前的“不确定性区间”才执行避让。一旦越过跳变点，视为逻辑已“兑现”。

#### 1. 向下趋势 (本策略核心：捕捉降温)
- **跳转点**：$X.5$ (例如 8.5°C 准备跳向 8°C)。
- **避让区**：$[X.5, X.5 + 0.3]$ (即 $X.5 \sim X.8$)。
    - **逻辑**：此时拟合值已跌落，但还没穿过 $X.5$，NOAA 仍然显示高位。此时入场存在“无法完成跳变”的反弹风险。
- **兑现区**：当 $V_{fit} < X.5$。
    - **逻辑**：拟合值已穿过中轴线，从四舍五入规律看，NOAA 应该已经（或即将）降档。风险已释放，**无需避让**。

#### 2. 向上趋势 (捕捉升温)
- **跳转点**：$X.5$ (例如 7.5°C 准备跳向 8°C)。
- **避让区**：$[X.5 - 0.3, X.5]$ (即 $X.2 \sim X.5$)。
    - **逻辑**：此时还没跳升，处于临界博弈期，需避让。
- **兑现区**：当 $V_{fit} > X.5$。
    - **逻辑**：已越过中轴线，向上跳变逻辑已兑现，**无需避让**。

## 3. 执行策略汇总矩阵
| 信号层级 | 核心关注点 | 性质 |
| :--- | :--- | :--- |
| **基础前提** | 时间窗口 + 预测值不反弹 | **强制拦截** |
| **物理驱动** | 多源共振 (支持跨源频次累加) | **核心触发** |
| **风险规避** | **跳转前**临界区避让 (越过 $X.5$ 即解除) | **逻辑确认** |

## 4. 异常处理与止损
- **反弹清零**：信号确认期间，若 `V_fit` 产生任何反向波动 > 0.1°C，则由于“不稳定性”重置所有买入计时。
- **数据中断**：若 OM 或 MN 任意一个源中断更新超过 10 分钟，系统自动进入防御模式，暂停交易。
