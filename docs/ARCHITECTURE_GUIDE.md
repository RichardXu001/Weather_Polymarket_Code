# 天气量化交易系统：架构设计文档 (v1.2)

## 1. 系统概览
本系统旨在通过自动化方式，利用多源天气数据源（NOAA, Open-Meteo, Met.no）与动态判定模型，在 Polymarket 天气预测市场上执行捕捉气温剧变（Drop）的量化策略。

## 2. 核心架构组件

### 2.1 数据采集网关 (Data Ingestion)
- **多源并发**：并行轮询 NOAA (METAR)、Open-Meteo、Met.no。
- **动态寻址**：基于 `locations.json` 自动解析经纬度及 **本地时区偏移 (TZ)**。
- **自适应采样**：支持 30s-60s 差异化采样频率。

### 2.2 策略判定内核 (Strategy Kernel - V4.2.2)
- **三阶段状态机**：根据本地时间自动在“严谨期”、“窗口期”、“灵敏期”间切换配置。
- **源锚点校验**：各数据源独立维护今日峰值状态，消除绝对值偏差。
- **价格熔断**：全线集成 > 0.5 USDC 的价格保护。
- **温标自适应 [NEW]**：根据站点 Preset 自动执行 C/F 换算，并利用正则语义匹配 Polymarket 非标准合约名。

### 2.3 审计与历史系统 (Auditing & History) [NEW]
- **实时录制**：记录每一时刻的所有天气源及市场深度。
- **交易存证**：对每一笔买入/跳过操作生成带逻辑证据的独立日志。
- **自动化快照**：回测完成后自动生成结构化审计报告 (`.md`)。

## 3. 核心文件布局
```text
project/
├── data/
│   ├── recordings/       # 原始天气与市场深度录制 (CSV)
│   ├── trades/           # [NEW] 独立交易信号存证 (CSV)
│   └── outcomes/         # 每日最高温结算结果
├── docs/                 # 技术文档与策略指南
├── engine/
│   ├── strategy.py       # 核心决策逻辑 (V4.2.2)
│   ├── config.py         # 环境参数管理器
│   └── data_feed.py      # WeatherState 状态定义
├── backtest_engine.py    # [NEW] 支持多 CSV 自动缝合的回测引擎
└── weather_bot.py        # 并行多站交易主程序
```

## 4. 回测与验证体系 (V4.2.2)
- **多 CSV 缝合**: 支持通配符加载断续数据流，自动处理时序重叠。
- **全维度归因**: 回测生成的 Markdown 报告可精确还原触发时的 Resonance/Duration 原因。
- **逻辑双子星**: 确保实盘与回测 100% 复用同一判定内核。

---
*最后更新：2026-02-10 | 文档版本：v1.2*
